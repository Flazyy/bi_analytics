<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <title>L'Ecole LDLC, projets "Be Influent" 2017</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
          integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        svg {
            height: 200px;
            min-height: 200px;
        }

        .legend_svg svg {
            height: 30px;
            min-height: 30px;
        }
    </style>
</head>

<body>

<nav class="navbar navbar-toggleable-md navbar-inverse fixed-top bg-inverse">
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse"
            aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="#">BI 2017</a>
    <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="#blog">Blog</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#facebook">Facebook</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#twitter">Twitter</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#instagram">Instagram</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#discord">Discord</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#youtube">Youtube</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#score">Scores</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#help">Aide</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container">

    <h1 class="header">KPI des projets <i>Be Influent</i> 2017</h1>

    <h2 class="header" id="blog">Blog / site vitrine</h2>
    <div class="row">
        <div class="legend_svg" id="blog_legend"></div>
    </div>
    <div class="row">
        <div class="col-4">
            <h4>Visiteurs</h4>
            <svg class="chart" id="blog_vu"></svg>
        </div>
        <div class="col-4">
            <h4>Temps moyen</h4>
            <svg class="chart" id="blog_tm"></svg>
        </div>
        <div class="col-4">
            <h4>Taux de rebond</h4>
            <svg class="chart" id="blog_tr"></svg>
        </div>
        <div class="col-4">
            <h4>Pages vues</h4>
            <svg class="chart" id="blog_pv"></svg>
        </div>
        <div class="col-4">
            <h4>Publications</h4>
            <svg class="chart" id="blog_np"></svg>
        </div>
        <div class="col-4">
            <h4>Newsletter</h4>
            <svg class="chart" id="blog_nz"></svg>
        </div>
    </div>

    <h3 class="header" id="facebook">Facebook</h3>
    <div class="row">
        <div class="legend_svg" id="fb_legend"></div>
    </div>
    <div class="row">
        <div class="col-4">
            <h4>Communauté</h4>
            <svg class="chart" id="fb_fa"></svg>
        </div>
        <div class="col-4">
            <h4>Portée</h4>
            <svg class="chart" id="fb_p"></svg>
        </div>
        <div class="col-4">
            <h4>Engagement</h4>
            <svg class="chart" id="fb_e"></svg>
        </div>
        <div class="col-4">
            <h4>Budget (€)</h4>
            <svg class="chart" id="fb_b"></svg>
        </div>
        <div class="col-4">
            <h4>Publications</h4>
            <svg class="chart" id="fb_np"></svg>
        </div>
    </div>

    <h3 class="header" id="twitter">Twitter</h3>
    <div class="row">
        <div class="legend_svg" id="tw_legend"></div>
    </div>
    <div class="row">
        <div class="col-4">
           <h4>Communauté</h4>
            <svg class="chart" id="tw_fa"></svg>
        </div>
        <div class="col-4">
            <h4>Portée</h4>
            <svg class="chart" id="tw_p"></svg>
        </div>
        <div class="col-4">
            <h4>Engagement</h4>
            <svg class="chart" id="tw_e"></svg>
        </div>
        <div class="col-4">
            <h4>Budget (€)</h4>
            <svg class="chart" id="tw_b"></svg>
        </div>
        <div class="col-4">
            <h4>Publications</h4>
            <svg class="chart" id="tw_np"></svg>
        </div>
    </div>

    <h3 class="header" id="instagram">Instagram</h3>
    <div class="row">
        <div class="legend_svg" id="insta_legend"></div>
    </div>
    <div class="row">
        <div class="col-4">
            <h4>Communauté</h4>
            <svg class="chart" id="insta_fa"></svg>
        </div>
        <div class="col-4">
            <h4>Portée</h4>
            <svg class="chart" id="insta_p"></svg>
        </div>
        <div class="col-4">
            <h4>Engagement</h4>
            <svg class="chart" id="insta_e"></svg>
        </div>
        <div class="col-4">
            <h4>Budget (€)</h4>
            <svg class="chart" id="insta_b"></svg>
        </div>
        <div class="col-4">
            <h4>Publications</h4>
            <svg class="chart" id="insta_np"></svg>
        </div>
    </div>

    <h3 class="header" id="discord">Discord</h3>
    <div class="row">
        <div class="legend_svg" id="discord_legend"></div>
    </div>
    <div class="row">
        <div class="col-4">
            <h4>Communauté</h4>
            <svg class="chart" id="discord_m"></svg>
        </div>
        <div class="col-4">
            <h4>Messages</h4>
            <svg class="chart" id="discord_ms"></svg>
        </div>
        <div class="col-4">
            <h4>Salons vocaux</h4>
            <svg class="chart" id="discord_v"></svg>
        </div>
    </div>

    <h3 class="header" id="youtube">Youtube</h3>
    <div class="row">
        <div class="legend_svg" id="yt_legend"></div>
    </div>
    <div class="row">
        <div class="col-4">
            <h4>Communauté</h4>
            <svg class="chart" id="yt_fa"></svg>
        </div>
        <div class="col-4">
            <h4>Vues</h4>
            <svg class="chart" id="yt_v"></svg>
        </div>
        <div class="col-4">
            <h4>Temps moyen (s)</h4>
            <svg class="chart" id="yt_t"></svg>
        </div>
    </div>

    <h3 class="header" id="score">Scores</h3>

    <div class="row">
        <div class="legend_svg" id="agg_legend"></div>
    </div>

    <div class="row">
        <div class="col-4">
            <h4>Blog</h4>
            <svg class="chart" id="blog_agg"></svg>
        </div>
        <div class="col-4">
            <h4>Facebook</h4>
            <svg class="chart" id="fb_agg"></svg>
        </div>
        <div class="col-4">
            <h4>Total</h4>
            <svg class="chart" id="total_score"></svg>
        </div>
    </div>

    <h3 class="header" id="help">Help</h3>

    <div class="row">
        <div class="col-12">
            <h4>KPI on blog / Website</h4>
            <ul>
                <li><b>Visiteurs</b> Nombre de visiteurs uniques sur la période</li>
                <li><b>Temps moyen</b> Temps moyen sur le site en secondes entières, sur la période</li>
                <li><b>Bounce rate</b> Taux de rebond en pourcent (pourcentage des visiteurs qui quitte le site tout de suite), sur la période</li>
                <li><b>Pages</b> Nombre moyen de pages vues par session</li>
                <li><b>Publications</b> Nombre de publications (articles) sur la période</li>
                <li><b>Abonnés newsletter</b> Nombre d'abonnés à la newsletter à la fin de la période</li>
            </ul>
            <h4>KPI on Social media (facebook, twitter, instagram)</h4>
            <ul>
                <li><b>Communauté</b> Nombre de fans/followers/subscribers à la fin de la période</li>
                <li><b>Portée</b> Nombre d'impressions sur la période</li>
                <li><b>Engagement</b> Nombre d'actions des visiteurs sur la période</li>
                <li><b>Budget (€)</b> Budget dépensé sur la période</li>
                <li><b>Publications</b> Nombre de publications</li>
            </ul>
            <h4>KPI on Discord</h4>
            <ul>
                <li><b>Communauté</b> Nombre de membres à la fin de la période</li>
                <li><b>Messages</b> Nombre de messages sur la période</li>
                <li><b>Salon vocaux</b> Nombre de membres actifs dans les salons vocaux sur la période</li>
            </ul>
            <h4>KPI on Youtube</h4>
            <ul>
                <li><b>Communauté</b> Nombre de membres à la fin de la période</li>
                <li><b>Vues</b> Nombre de vues sur la période</li>
                <li><b>Temps moyen</b> Temps moyen de visionnage sur la période</li>
            </ul>
        </div>
    </div>

    <a href="#0" class="cd-top">Top</a>
</div> <!-- /container -->

</body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
        integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
        integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
<script src="js/moment-with-locales.js"></script>
<script src="js/modernizr.js"></script>
<script src="js/main.js"></script>

<script type="text/javascript">
    var URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2m4zHV6_3opJl0GwBk2KYynzm2Fjs4MWdtPL5ku7ss7oc1b1CA64667BAfpPDnAd5noyUUnu9x12c/pub?gid=0&single=true&output=csv';
    var projects = ['Paye ta planche', 'Acthulhu', 'Red Nugget', 'Au gamer Apaisé', 'La planche a repasser']
    var color = d3.scaleOrdinal([
        'rgb(31, 119, 180)', // Paye ta planche
        '#3EAD4E', // Acthulu
        'rgb(214, 39, 40)', // Red nugget
        'rgb(255, 127, 14)', // Au gamer apaisé
        'rgb(148, 103, 189)' // La planche à repasser
    ]);

    function legend(color, elem) {
        var legendRectSize = 15;
        var legendSpacing = 4;
        var svg = d3.select('#' + elem).append('svg')
            .attr('width', 960)
            .attr('height', 30);

        console.log(svg);
        var legend = svg.selectAll('.legend')
            .data([1, 2, 3, 4, 5])
            .enter()
            .append('g')
            .attr('class', 'legend')
            .attr('transform', function (d, i) {
                var horz = 0 + i * 180 + 10;
                var vert = 0;
                return 'translate(' + horz + ',' + vert + ')';
            });

        // These are the rectangles
        legend.append('rect')
            .attr('width', legendRectSize)
            .attr('height', legendRectSize)
            .style('fill', color)
            .style('stroke', color);

        // These are the texts
        legend.append('text')
            .attr('x', legendRectSize + 5)
            .attr('y', 15)
            .text(function (d) {
                return projects[d - 1]
            });
    }

    function draw_grouped_barchart(data, e, key, color) {
        var w = 300, h = 200;
        var svg = d3.select(e),
            margin = {top: 5, right: 20, bottom: 20, left: 25},
            width = w - margin.left - margin.right,
            height = h - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var x0 = d3.scaleBand()
            .rangeRound([0, width])
            .paddingInner(0.1);

        var x1 = d3.scaleBand()
            .padding(0.05);

        var y = d3.scaleLinear()
            .rangeRound([height, 0]);

        var weeks = [43]
        x0.domain(weeks);
        keys = [1, 2, 3, 4, 5]
        x1.domain(keys).rangeRound([0, x0.bandwidth()]);
        y.domain([0, d3.max(data, function (d) {
            return d[key];
        })]).nice();
        g.append("g")
            .selectAll("g")
            .data(weeks)
            .enter().append("g")
            .attr("transform", function (d) {
                return "translate(" + x0(d) + ",0)";
            })
            .selectAll("rect")
            .data(data)
            .enter()
            .filter(function (d) {
                return !isNaN(+d[key]);
            })
            .append("rect")
            .attr("x", function (d) {
                return x1(d.id);
            })
            .attr("y", function (d) {
                return y(d[key]);
            })
            .attr("width", x1.bandwidth())
            .attr("height", function (d) {
                return height - y(d[key]);
            })
            .attr("fill", function (d) {
                return color(d.id);
            });

        g.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + (height) + ")")
            .call(d3.axisBottom(x0));

        g.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y))


    }

    function gen_scale(key, min) {
        return d3.scaleLinear()
            .domain([min ? min : d3.min(data, function (d) {
                return d[key];
            }), d3.max(data, function (d) {
                return d[key];
            })])
            .range([0, 1])
    }

    $(function () {
        $(".legend_svg").each(function (index) {
            legend(color, $(this).attr('id'));
        });

        $.get(URL, function (textString) {
            console.log("data loaded");
            var data_full = d3.csvParseRows(textString)
            data = [];
            data_full.forEach(function (d) {
                dh = parseInt(d[7], 10);
                if (!isNaN(dh)) {
                    i = 3;
                    data.push({
                        'id': d[i++],
                        'week': +d[i++],
                        'date_start': moment(d[i++], 'DD/MM/YYYY'),
                        'date_end': moment(d[i++], 'DD/MM/YYYY'),
                        'blog_vu': +d[i++].replace(',', '.'),
                        'blog_tm': +d[i++].replace(',', '.'),
                        'blog_tr': +(d[i++].replace('%', '').replace(',', '.')),
                        'blog_pv': +d[i++].replace(',', '.'),
                        'blog_np': +d[i++].replace(',', '.'),
                        'blog_nz': +d[i++].replace(',', '.'),
                        'fb_fa': +d[i++].replace(',', '.'),
                        'fb_p': +d[i++].replace(',', '.'),
                        'fb_e': +d[i++].replace(',', '.'),
                        'fb_b': +d[i++].replace(',', '.'),
                        'fb_np': +d[i++].replace(',', '.'),
                        'tw_fa': +d[i++].replace(',', '.'),
                        'tw_p': +d[i++].replace(',', '.'),
                        'tw_e': +d[i++].replace(',', '.'),
                        'tw_b': +d[i++].replace(',', '.'),
                        'tw_np': +d[i++].replace(',', '.'),
                        'insta_fa': +d[i++].replace(',', '.'),
                        'insta_p': +d[i++].replace(',', '.'),
                        'insta_e': +d[i++].replace(',', '.'),
                        'insta_b': +d[i++].replace(',', '.'),
                        'insta_np': +d[i++].replace(',', '.'),
                        'discord_m': +d[i++].replace(',', '.'),
                        'discord_ms': +d[i++].replace(',', '.'),
                        'discord_v': +d[i++].replace(',', '.'),
                        'yt_fa': +d[i++].replace(',', '.'),
                        'yt_v': +d[i++].replace(',', '.'),
                        'yt_t': +d[i++].replace(',', '.'),
                        'blog_agg': 0,
                        'fb_agg': 0,
                        'total_score': 0
                    });
                }
            });
            console.log(data);
            data.forEach(function (d) {
                blog_vu_scale = gen_scale('blog_vu');
                blog_tm_scale = gen_scale('blog_tm');
                blog_pv_scale = gen_scale('blog_pv');
                d.blog_agg = (blog_vu_scale(d.blog_vu) + blog_tm_scale(d.blog_tm) + blog_pv_scale(d.blog_pv)) / 3 * 100;

            });

            $(".chart").each(function (index) {
                var id = $(this).attr('id');
                draw_grouped_barchart(data, "#" + id, id, color);
            });
        });
    });
</script>
</html>
